name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Cross-platform build with cross
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Install cross
        run: cargo install cross

      - name: Extract version from tag or default
        id: extract_version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          else
            echo "VERSION=manual-$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV
          fi

      - name: Build Linux binary
        run: cross build --release --target x86_64-unknown-linux-gnu

      - name: Build Windows binary
        run: cross build --release --target x86_64-pc-windows-gnu

      - name: Build macOS binary
        run: cross build --release --target x86_64-apple-darwin

      - name: Prepare binaries
        run: |
          mkdir dist

          # Linux
          cp target/x86_64-unknown-linux-gnu/release/ytdownloader dist/ytdownloader
          zip dist/$VERSION-linux.zip -j dist/ytdownloader
          rm dist/ytdownloader

          # Windows
          cp target/x86_64-pc-windows-gnu/release/ytdownloader.exe dist/ytdownloader.exe
          zip dist/$VERSION-windows.zip -j dist/ytdownloader.exe
          rm dist/ytdownloader.exe

          # macOS
          cp target/x86_64-apple-darwin/release/ytdownloader dist/ytdownloader
          zip dist/$VERSION-macos.zip -j dist/ytdownloader
          rm dist/ytdownloader

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/$VERSION-linux.zip
            dist/$VERSION-windows.zip
            dist/$VERSION-macos.zip
